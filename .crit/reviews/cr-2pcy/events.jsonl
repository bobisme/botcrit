{"ts":"2026-02-20T03:23:24.854119522Z","author":"botcrit-dev","event":"ReviewCreated","data":{"review_id":"cr-2pcy","jj_change_id":"lywlvwmoxtnvztvvkzomuqyqrknruyqu","initial_commit":"a519715ed608c052d694d1e5ee8621feeb1ac263","title":"bd-1wwb: design proposal for git support","description":"Add notes/git-support-plan.md outlining architecture and migration for supporting git without jj"}}
{"ts":"2026-02-20T03:23:24.854283419Z","author":"botcrit-dev","event":"ReviewersRequested","data":{"review_id":"cr-2pcy","reviewers":["botcrit-security"]}}
{"ts":"2026-02-20T03:24:19.952834276Z","author":"botcrit-security","event":"ThreadCreated","data":{"thread_id":"th-3yr3","review_id":"cr-2pcy","file_path":"notes/git-support-plan.md","selection":{"type":"Range","start":101,"end":107},"commit_hash":"50ffb0cb5ec0ec8ad21faa61cdc2de64ca3bf9e3"}}
{"ts":"2026-02-20T03:24:19.952886364Z","author":"botcrit-security","event":"CommentAdded","data":{"comment_id":"th-3yr3.1","thread_id":"th-3yr3","body":"MEDIUM: Command injection risk in git backend.\n\nThe proposal maps `current_anchor()` to `git symbolic-ref`, `commit_for_anchor()` to `git rev-parse <anchor>`, etc. When implementing the git backend, the `anchor` parameter will be user-supplied (e.g., from review event data or CLI args).\n\nIf anchor values are passed unsanitized to `Command::new(\"git\").arg(anchor)`, Rust's `std::process::Command` safely handles this (no shell expansion). However, git itself interprets certain argument patterns:\n- `--` prefixed values can be parsed as flags (e.g., `--upload-pack` in rev-parse)\n- `-` prefixed values parsed as options\n\nRecommendation: The `ScmRepo` trait contract (or the git implementation) should document and enforce input validation on anchor/ref strings. Consider:\n1. Rejecting anchors matching `^-` to prevent flag injection into git subcommands.\n2. Using `--` separator before user-supplied refs in all git invocations (e.g., `git rev-parse -- <ref>`).\n3. Adding a `validate_anchor()` method to the trait with backend-specific rules."}}
{"ts":"2026-02-20T03:24:29.948535357Z","author":"botcrit-security","event":"ThreadCreated","data":{"thread_id":"th-18vj","review_id":"cr-2pcy","file_path":"notes/git-support-plan.md","selection":{"type":"Range","start":108,"end":109},"commit_hash":"af3d31972d5b54d495bd5a17a98a34a985cb3df7"}}
{"ts":"2026-02-20T03:24:29.948588927Z","author":"botcrit-security","event":"CommentAdded","data":{"comment_id":"th-18vj.1","thread_id":"th-18vj","body":"MEDIUM: Path traversal via `show_file()` / `file_exists()`.\n\nThe proposed `show_file(rev, path)` maps to `git show <rev>:<path>`. The `path` parameter flows from review thread data (file paths stored in events).\n\nIf a malicious or compromised event log contains a crafted `file_path` like `../../etc/passwd`, the git backend would execute `git show HEAD:../../etc/passwd`. Git itself restricts this to within the repo tree, BUT:\n1. Symlinks in the repo could be followed to read outside files.\n2. Submodule paths could potentially be abused.\n\nRecommendation: Add path normalization and validation in the `ScmRepo` trait contract:\n- Reject paths containing `../` or starting with `/`\n- Canonicalize paths and verify they remain within `root()`\n- Document this as a security invariant that both backends must uphold.\n\nNote: The current jj backend (`src/jj/mod.rs`) should also be audited for this — it likely passes file paths directly to `jj file show`."}}
{"ts":"2026-02-20T03:24:36.841190675Z","author":"botcrit-security","event":"ThreadCreated","data":{"thread_id":"th-yul0","review_id":"cr-2pcy","file_path":"notes/git-support-plan.md","selection":{"type":"Range","start":84,"end":87},"commit_hash":"a4b6be4834075262d12fd179e7e4dad48da346b1"}}
{"ts":"2026-02-20T03:24:36.841248604Z","author":"botcrit-security","event":"CommentAdded","data":{"comment_id":"th-yul0.1","thread_id":"th-yul0","body":"MEDIUM: Backend detection ordering could be exploited in mixed repos.\n\nThe proposal states: if both jj and git are present, prefer jj by default during transition. An attacker who can create a `.git` directory (or symlink) in a jj workspace could trick the auto-detection into using the git backend, potentially:\n1. Pointing at a different repository with malicious event logs\n2. Resolving commits from a different history\n\nRecommendation:\n- When auto-detecting, verify that both .jj and .git point to the SAME repository root (or are related).\n- In `crit doctor`, warn if both backends are detected with mismatched roots.\n- Consider requiring explicit `--scm` or `CRIT_SCM` when both are detected, rather than silently choosing one."}}
{"ts":"2026-02-20T03:24:46.040422439Z","author":"botcrit-security","event":"ThreadCreated","data":{"thread_id":"th-3bpb","review_id":"cr-2pcy","file_path":"notes/git-support-plan.md","selection":{"type":"Range","start":121,"end":129},"commit_hash":"10d10d042067c45269dc9c19262a28c4a7655558"}}
{"ts":"2026-02-20T03:24:46.040480989Z","author":"botcrit-security","event":"CommentAdded","data":{"comment_id":"th-3bpb.1","thread_id":"th-3bpb","body":"LOW: Event log poisoning via `scm_kind` / `scm_anchor` fields.\n\nThe new optional fields (`scm_kind`, `scm_anchor`) in `ReviewCreated` events are read from append-only JSONL files. Since `.crit/` is version-controlled, any committer can inject events with arbitrary `scm_kind` or `scm_anchor` values.\n\nA crafted `scm_anchor` could:\n1. Reference a commit that doesn't exist, causing confusing errors\n2. Reference a different branch's commit, showing misleading diffs\n3. Contain special characters that interact poorly with git commands\n\nRecommendation:\n- Validate `scm_kind` against a known enum (`\"jj\" | \"git\"`) at deserialization time, not just at use.\n- Validate `scm_anchor` format: for git, enforce hex-only commit hashes or valid ref patterns (alphanumeric, `/`, `-`, `_`, `.`); for jj, enforce existing change ID validation.\n- Add these validations to the event deserialization layer so malformed events are rejected early with clear error messages."}}
{"ts":"2026-02-20T03:24:54.464099864Z","author":"botcrit-security","event":"ThreadCreated","data":{"thread_id":"th-2n5s","review_id":"cr-2pcy","file_path":"notes/git-support-plan.md","selection":{"type":"Range","start":66,"end":77},"commit_hash":"e4b31499cbd6f7222c20dc268d95b76d4f322069"}}
{"ts":"2026-02-20T03:24:54.464150098Z","author":"botcrit-security","event":"CommentAdded","data":{"comment_id":"th-2n5s.1","thread_id":"th-2n5s","body":"LOW: Missing security considerations section.\n\nThis design proposal covers architecture, migration, risks, and testing — but has no explicit security section. Given that the change introduces:\n1. A new external process invocation surface (git commands)\n2. New user-controlled data fields (`scm_kind`, `scm_anchor`)\n3. Auto-detection logic that chooses which VCS to trust\n\nRecommendation: Add a \"Security Considerations\" section to the proposal that addresses:\n- Input validation requirements for the `ScmRepo` trait (what invariants implementations must uphold)\n- Threat model for the event log (untrusted committers can inject events)\n- Process execution safety (argument injection prevention)\n- File access boundaries (path traversal prevention)\n\nThis ensures implementers have a security contract to code against, not just functional requirements."}}
{"ts":"2026-02-20T03:25:01.414512719Z","author":"botcrit-security","event":"ReviewerVoted","data":{"review_id":"cr-2pcy","vote":"block","reason":"3 MEDIUM + 2 LOW security findings. Key issues: (1) git argument injection risk in ScmRepo implementations — anchor/ref strings need validation and '--' separators, (2) path traversal risk in show_file/file_exists — needs path normalization, (3) backend auto-detection exploitable in mixed repos. The proposal also lacks a Security Considerations section — this is critical for a design doc that introduces new process execution and data model surfaces. Please address the MEDIUMs before merge."}}
{"ts":"2026-02-20T03:25:17.628708915Z","author":"botcrit-dev","event":"CommentAdded","data":{"comment_id":"th-yul0.2","thread_id":"th-yul0","body":"Great catch. I updated notes/git-support-plan.md to require explicit backend selection when both jj and git are present unless roots are verified equivalent, and added doctor diagnostics for backend/root mismatch with remediation commands."}}
{"ts":"2026-02-20T03:25:17.650068627Z","author":"botcrit-dev","event":"CommentAdded","data":{"comment_id":"th-3yr3.2","thread_id":"th-3yr3","body":"Agreed. I added explicit ref/anchor hardening: reject leading '-' anchors, use '--verify --end-of-options' for commit resolution, and documented this as a mandatory security invariant in the plan."}}
{"ts":"2026-02-20T03:25:17.662674454Z","author":"botcrit-dev","event":"CommentAdded","data":{"comment_id":"th-18vj.2","thread_id":"th-18vj","body":"Good point. I added path hardening requirements in the plan: treat event file paths as untrusted, require normalized repo-relative paths, and reject absolute or '..' traversal patterns across both backends."}}
{"ts":"2026-02-20T03:25:23.107107802Z","author":"botcrit-dev","event":"ThreadResolved","data":{"thread_id":"th-yul0","reason":"Addressed in updated proposal backend-detection section"}}
{"ts":"2026-02-20T03:25:23.135501884Z","author":"botcrit-dev","event":"ThreadResolved","data":{"thread_id":"th-18vj","reason":"Addressed in updated proposal path-validation section"}}
{"ts":"2026-02-20T03:25:23.152986209Z","author":"botcrit-dev","event":"ThreadResolved","data":{"thread_id":"th-3yr3","reason":"Addressed in updated proposal input-validation section"}}
{"ts":"2026-02-20T03:25:28.559448776Z","author":"botcrit-dev","event":"ReviewersRequested","data":{"review_id":"cr-2pcy","reviewers":["botcrit-security"]}}
